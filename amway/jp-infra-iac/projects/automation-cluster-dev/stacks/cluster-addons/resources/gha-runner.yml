# Inspired by: https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml
# template:
#   spec:
#     restartPolicy: Never
#     serviceAccountName: jpn-automation-dev-gha-rs-no-permission
#     containers:
#       - name: runner
#         image: 492449516969.dkr.ecr.ap-northeast-1.amazonaws.com/jp-cicd-gha-runner:v4
#         command: ["/home/runner/run.sh"]
#         volumeMounts:
#           - mountPath: "/scratch"
#             name: scratch
#     volumes:
#       - name: scratch
#         ephemeral:
#           volumeClaimTemplate:
#             spec:
#               accessModes: ["ReadWriteOnce"]
#               storageClassName: "gp2"
#               resources:
#                 requests:
#                   storage: 40Gi
template:
  spec:
    initContainers:
    - name: init-dind-externals
      image:  492449516969.dkr.ecr.ap-northeast-1.amazonaws.com/jp-cicd-gha-runner:v5  # ghcr.io/actions/actions-runner:latest
      command: ["cp", "-r", "-v", "/home/runner/externals/.", "/home/runner/tmpDir/"]
      volumeMounts:
        - name: dind-externals
          mountPath: /home/runner/tmpDir
    containers:
    - name: runner
      image: 492449516969.dkr.ecr.ap-northeast-1.amazonaws.com/jp-cicd-gha-runner:v5
      command: ["/home/runner/run.sh"]
      env:
        - name: DOCKER_HOST
          value: unix:///run/docker/docker.sock
      volumeMounts:
        - name: work
          mountPath: /home/runner/_work
        - name: dind-sock
          mountPath: /run/docker
          readOnly: true
    - name: dind
      image: docker:dind
      args:
        - dockerd
        - --host=unix:///run/docker/docker.sock
        - --group=$(DOCKER_GROUP_GID)
      env:
        - name: DOCKER_GROUP_GID
          value: "123"
      securityContext:
        privileged: true
      volumeMounts:
        - name: docker
          mountPath: /var/lib/docker
        - name: work
          mountPath: /home/runner/_work
        - name: dind-sock
          mountPath: /run/docker
        - name: dind-externals
          mountPath: /home/runner/externals
    volumes:
    - name: work
      emptyDir: {}
    - name: dind-sock
      emptyDir: {}
    - name: dind-externals
      emptyDir: {}
    - name: docker
      ephemeral:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            storageClassName: "gp2"
            resources:
              requests:
                storage: 20Gi
