name: Hybris Tests EU by Country on Env

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: "Environment name"
        required: true
        default: ultraserve_fqa
        options:
          - ultraserve_fqa
          - ultraserve_uat
          - ultraserve_nft
          - ultraserve_stg
          - uat1
          - uat2
          - uat3
          - uat4
          - fqa1
          - fqa2
          - fqa3
          - fqa4

      country:
        type: choice
        description: "Country name"
        required: true
        default: finland
        options:
          - finland
          - sweden
          - denmark
          - norway
          - spain
          - portugal
          - netherlands
          - belgium
          - italy
          - germany
          - france
          - switzerland
          - austria
          - turkey
          - poland
          - greece
          - romania
          - croatia
          - czech_republic
          - slovenia
          - slovakia
          - estonia
          - latvia
          - lithuania
          - bulgaria
          - hungary
          - united_kingdom
          - ireland

      cycle:
        description: "Optional: Cycle key in JIRA (i.e. 'AMWEIA-C15696')"
        required: false

env:
  ECR_REGISTRY: "744058822102.dkr.ecr.eu-central-1.amazonaws.com"
  DOCKER_CONFIG: "/home/github/.docker"
  # Tests related vars
  BROWSER: chrome
  COUNTRY: ${{ github.event.inputs.country }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  TEST_RUN_ID: ""
  ARTIFACTS_DIR: b2c_ootb/target/allure-results
  REPORT_DIR: amway-test-system-ui-tests/target/site/allure-maven-plugin
  REPORT_HISTORY_DIR: amway-test-system-ui-tests/target/site/allure-maven-plugin/history

  # Reports related vars
  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME}}
  REPORT_URL: "https://allure-reports.hybris.eu.eia.amway.net"
  CYCLE: ${{ github.event.inputs.cycle }}

  # actions related vars
  ACTIONS_REPO: AmwayCommon/actions

  # Notifications related vars
  SMTP_SERVER: relay.hybris.eu.eia.amway.net
  RCPTS: Amway.EU.AQA@Amway.com
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
jobs:
  history:
    name: History cleaning (t3a.medium)
    runs-on: [ self-hosted, t3a.medium ]
    timeout-minutes: 180
    if: ${{ always() }}

    env:
      INCLUDE_TEST: "AllureReportsHistoryFilter"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"
          HISTORY_DIR="./history"
          S3_HISTORY_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/history"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV
          echo "HISTORY_DIR=$HISTORY_DIR" >> $GITHUB_ENV
          echo "S3_HISTORY_URL=$S3_HISTORY_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Checkout ${{ env.ACTIONS_REPO }} repo
        uses: actions/checkout@v4
        with:
          path: actions
          token: ${{ secrets.GIT_TOKEN }}
          repository: ${{ env.ACTIONS_REPO }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Check and copy previously-saved history folder to project dir
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          mkdir $HISTORY_DIR
          aws s3 cp --recursive $S3_HISTORY_URL $HISTORY_DIR
          if [ -z "$(ls -A $HISTORY_DIR)"]; then
            echo there is NO history FOUND for this workflow
          else
            echo this workflow history is copied from $S3_HISTORY_URL
          fi

      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          mvn -e clean install -Dbrowser=$BROWSER \
                               -DfailIfNoTests=$FAIL_IF_NO_TESTS \
                               -PdataGenerator \
                               -Dcountry=$COUNTRY \
                               -Denv=$ENVIRONMENT \
                               -Dtest=$INCLUDE_TEST

      - name: Try to upload filtered history back to s3
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          if [ -z "$(ls -A $HISTORY_DIR)"]; then
              echo History dir of report NOT FOUND
              echo "HISTORY_UPLOADED=no" >> $GITHUB_ENV
              exit 0
          else
              echo Going to upload filtered history to s3
              aws s3 cp --quiet --recursive $HISTORY_DIR $S3_HISTORY_URL
              echo "HISTORY_UPLOADED=yes" >> $GITHUB_ENV
              echo History was uploaded
          fi

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_01:
    name: Hybris_01 (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 01
      INCLUDE_TEST: "@Hybris_01"
      EXCLUDE_TEST: "@excluded"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_02:
    name: Hybris_02 (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 02
      INCLUDE_TEST: "@Hybris_02"
      EXCLUDE_TEST: "@excluded"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf


  job_03:
    name: Hybris_03 (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 03
      INCLUDE_TEST: "@Hybris_03"
      EXCLUDE_TEST: "@excluded"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf


  job_04:
    name: Hybris_04 Single orders (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 04
      INCLUDE_TEST: "(@Hybris_04 and @SingleOrder)"
      EXCLUDE_TEST: "(@CancelOrder or @excluded)"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_05:
    name: Hybris_04 MultiCart Orders (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 05
      INCLUDE_TEST: "(@Hybris_04 and @MultiCart)"
      EXCLUDE_TEST: "(@CancelOrder or @excluded)"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_06:
    name: Hybris_04 GCO orders (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 06
      INCLUDE_TEST: "(@Hybris_04 and @Gco)"
      EXCLUDE_TEST: "(@CancelOrder or @excluded)"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_07:
    name: Hybris_04 Country Specific Orders (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 07
      INCLUDE_TEST: "(@Hybris_04 and @CountrySpecificOrders)"
      EXCLUDE_TEST: "(@CancelOrder or @excluded)"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_08:
    name: Hybris_04 Promo and Coupons (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 08
      INCLUDE_TEST: "(@Hybris_04 and @Promo)"
      EXCLUDE_TEST: "(@CancelOrder or @excluded)"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_09:
    name: Hybris_04 Copy order (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 09
      INCLUDE_TEST: "(@Hybris_04 and @CopyOrder)"
      EXCLUDE_TEST: "(@CancelOrder or @excluded)"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_10:
    name: Hybris_04 Order edit address (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 10
      INCLUDE_TEST: "(@Hybris_04 and @OrderEditAddress)"
      EXCLUDE_TEST: "@excluded"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_11:
    name: Hybris_05 (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 11
      INCLUDE_TEST: "@Hybris_05"
      EXCLUDE_TEST: "@excluded"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_12:
    name: Hybris_06 (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 12
      INCLUDE_TEST: "@Hybris_06"
      EXCLUDE_TEST: "@excluded"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_13:
    name: Hybris_11 (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 13
      INCLUDE_TEST: "@Hybris_11"
      EXCLUDE_TEST: "@excluded"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_14:
    name: Hybris_12 or Hybris_15 (t3a.xlarge)
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ history ]

    env:
      JOB_NUM: 14
      INCLUDE_TEST: "(@Hybris_12 or @Hybris_15)"
      EXCLUDE_TEST: "(@CancelOrder or @excluded)"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -Pregression \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  job_15:
    name: Order cancel tests
    runs-on: [ self-hosted, t3a.xlarge ]
    timeout-minutes: 180
    needs: [ job_01, job_02, job_03, job_04, job_05, job_06, job_07, job_08, job_09, job_10, job_11, job_12, job_13, job_14 ]
    if: ${{ always() }}

    env:
      JOB_NUM: 15
      INCLUDE_TEST: "@CancelOrder and @hybris_eu"
      EXCLUDE_TEST: "@excluded"

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Maven execute
        shell: bash
        env:
          DISPLAY: ":1.0"
        working-directory: ${{ env.CODEBASE }}
        run: |
          RI1_COUNTRIES=(finland sweden denmark norway)
          RI2_COUNTRIES=(spain portugal netherlands belgium)
          RI3_COUNTRIES=(italy germany switzerland austria france)
          RI4_COUNTRIES=(turkey poland greece romania croatia czech_republic slovenia slovakia estonia latvia lithuania bulgaria hungary united_kingdom ireland)

          # if ri1 group
          if printf '%s\n' "${RI1_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri1"
          # elif ri2 group
          elif printf '%s\n' "${RI2_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri2"
           # elif ri3 group
          elif printf '%s\n' "${RI3_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri3"
           # elif ri4 group
          elif printf '%s\n' "${RI4_COUNTRIES[@]}" | grep -q -P $COUNTRY; then
          ROLL_IN="ri4"
          else
          echo "Error: country not in the RI list"
          fi
          echo "$INCLUDE_TEST $ROLL_IN $COUNTRY"
          mvn clean install -Dbrowser=$BROWSER \
                            -PsingleThread \
                            -Dcountry=$COUNTRY \
                            -Denv=$ENVIRONMENT \
                            -DtestRunId=$TEST_RUN_ID \
                            -Dcycle=$CYCLE \
                            -Dcucumber.filter.tags="$INCLUDE_TEST and (@$COUNTRY or @$ROLL_IN) and not $EXCLUDE_TEST"

      - name: Try to upload allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          # Try to copy allure report
          if [ -d $ARTIFACTS_DIR ]; then
              mkdir -p allure
              for i in $ARTIFACTS_DIR/*; do cp -rf "$i" allure; done
          else
              echo Reports dir NOT FOUND
              exit 0
          fi

          # Upload allure report to s3
          tar -zcf allure_$JOB_NUM.tar.gz allure
          aws s3 cp  allure_$JOB_NUM.tar.gz  $S3_FULL_URL/allure_$JOB_NUM.tar.gz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf

  summary:
    name: Generate results (t3a.medium)
    runs-on: [ self-hosted, t3a.medium ]
    timeout-minutes: 180
    needs: [ job_01, job_02, job_03, job_04, job_05, job_06, job_07, job_08, job_09, job_10, job_11, job_12, job_13, job_14, job_15 ]
    if: ${{ always() }}

    steps:
      - name: Helper step
        shell: bash
        run: |
          ip_addr=$(ip --brief a | tail -n1 | awk '{print $3}')
          echo "Agent IP address is: ${ip_addr%/*}"

          CODEBASE="${GITHUB_REPOSITORY##*/}"
          WORKFLOW_NAME=$(echo ${GITHUB_WORKFLOW,,} | sed -e 's:\s:_:g')
          S3_FULL_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"
          ALLURE_RESULTS_HISTORY_DIR="b2c_ootb/target/allure-results/history"
          S3_HISTORY_URL="s3://$S3_BUCKET_NAME/$WORKFLOW_NAME/history"

          # Set usefull env vars for next steps
          echo "CODEBASE=$CODEBASE" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "S3_FULL_URL=$S3_FULL_URL" >> $GITHUB_ENV
          echo "ALLURE_RESULTS_HISTORY_DIR=$ALLURE_RESULTS_HISTORY_DIR" >> $GITHUB_ENV
          echo "S3_HISTORY_URL=$S3_HISTORY_URL" >> $GITHUB_ENV

      - name: Checkout AmwayAutoQA repo
        uses: actions/checkout@v4
        with:
          path: ${{ env.CODEBASE }}

      - name: Checkout ${{ env.ACTIONS_REPO }} repo
        uses: actions/checkout@v4
        with:
          path: actions
          token: ${{ secrets.GIT_TOKEN }}
          repository: ${{ env.ACTIONS_REPO }}

      - name: Login into the AWS ECR registry
        shell: bash
        run: |
          aws ecr get-login-password --region  eu-central-1   | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}


      - name: Download artifacts from the previous steps
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          mkdir -p $ARTIFACTS_DIR
          cd $ARTIFACTS_DIR

          # Copy results for s3 to appropriate dir
          aws s3 cp --quiet --recursive  $S3_FULL_URL .
          for file in *.tar.gz; do
              tar -zxf $file
          done

          for x in allure/*; do mv -- "$x" .; done
          rmdir allure

      - name: Check and copy previously-saved history folder to allure-results
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          cd $ARTIFACTS_DIR
          mkdir history
          aws s3 cp --recursive $S3_HISTORY_URL ./history
          if [ -z "$(ls -A ./history)"]; then
            echo there is NO history FOUND for this workflow
          else
            echo this workflow history is copied
          fi

      - name: Generate allure report
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          mvn allure:report

      - name: Upload prepared allure report to s3
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          aws s3 cp --recursive "$REPORT_DIR" $S3_FULL_URL

      - name: Try to upload history of allure report
        if: ${{ always() }}
        shell: bash
        working-directory: ${{ env.CODEBASE }}
        run: |
          if [ -d $REPORT_HISTORY_DIR ]; then
              ls -A $REPORT_HISTORY_DIR
              echo Going to upload report history to s3
              aws s3 cp --quiet --recursive $REPORT_HISTORY_DIR $S3_HISTORY_URL
              echo "HISTORY_UPLOADED=yes" >> $GITHUB_ENV
              echo History was uploaded
          else
              echo History dir of report NOT FOUND
              tmpVar=$(ls $REPORT_DIR)
              echo "Showing Report directory structure: $tmpVar"
              echo "HISTORY_UPLOADED=no" >> $GITHUB_ENV
              exit 0
          fi

      - name: Print results of scheduled tests
        shell: bash
        run: |
          echo
          echo "Allure report could be found here: $REPORT_URL/$WORKFLOW_NAME/N$GITHUB_RUN_NUMBER"

      - name: Notify after completion (email media)
        if: ${{ always() }}
        uses: "./actions/send-email"
        with:
          smtp_server: ${{ env.SMTP_SERVER }}
          rcpts: ${{ env.RCPTS}}
          subj: "${{ github.workflow }} #${{ github.run_number}} COMPLETED"
          to: Amway.EU.AQA@Amway.com
          msg: |
            <h1> ${{ github.workflow }} ${{ github.run_number}} COMPLETED</h1>
            <p>Allure Report for ${{ env.COUNTRY }} could be found <a href='${{ env.REPORT_URL }}/${{ env.WORKFLOW_NAME}}/N${{ github.run_number }}'>here</a> </p>

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ env.ECR_REGISTRY }}

      - name: Clean up
        shell: bash
        if: ${{ always() }}
        run: |
          ls -A | xargs -n 1 rm -rf
