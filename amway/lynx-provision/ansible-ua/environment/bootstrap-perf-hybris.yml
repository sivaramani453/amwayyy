---
# Apply common configuration
- hosts: all
  vars:
    hotfolder_root_path: "/opt/hotfolder"
    hybris_env_ant_opts: "-Xmx1g -Dfile.encoding=UTF-8"
    # python -c 'import crypt; print crypt.crypt("This is my Password", "$1$SomeSalt$")'
    hybris_user_password: "$1$SomeSalt$ZPlQbPwkyCQJ01vGNIRNE0"
    hybrisd_service_startup_delay: 30
    env_customization: "perf"
  remote_user: root
# Just to make things easy
  pre_tasks:
    - name: "Disable Selinux"
      become: True
      selinux:
        state: "disabled"

  roles:
   - role: '../roles/lean_delivery.java'
     transport: "web"
     transport_web: "https://nexus.hybris.eia.amway.net/repository/static-files/static-dev/jre-8u171-linux-x64.tar.gz"

   - role: '../roles/lean_delivery.hybris_bootstrap_node'
     htools_username: "hybris"
     htools_groupname: "hybris"
     htools_upload_dir: "/opt"
     htools_purge_hybris_home: True
     htools_legacy_structure: True
     htools_artifact_storage: "https://nexus.hybris.eia.amway.net/service/rest/repository/browse/aweu-eia"

   - role: '../roles/lean_delivery.nodejs'
     nodejs_branch: 12
     nodejs_version: 12.13.0
     build_tools: True

   - role: '../roles/lean_delivery.zabbix_agent'
     zabbix_agent_server: "10.130.115.160,zabbix.hybris.eia.amway.net"
     zabbix_agent_serveractive: "10.130.115.160,zabbix.hybris.eia.amway.net"
     zabbix_agent_hostname: "{{ ansible_default_ipv4.address }}"

   - role: '../roles/filebeat-multiline'
     filebeat_version: 6.5.0
     filebeat_node_name: "filebeat"
     filebeat_output: "elasticsearch"
     es:
       host: https://vpc-aws-elasticsearch-5unizluspnic6n5zudjomi7eam.eu-central-1.es.amazonaws.com:443
       port: 443
     filebeat_inputs:
       - name: hybris
         paths:
           - '/opt/hybris/log/tomcat/console*.log'
         fields:
           logtype: hybris
           index_name: hybris-console
       - name: access
         paths:
           - '/opt/hybris/log/tomcat/access*.log'
         fields:
           logtype: access
           index_name: hybris-access
 
# Post-install configuration
  post_tasks:
    - name: "Setup hybris user password"
      become: True
      user: 
        name: "{{ htools_username }}"
        password: "{{ hybris_user_password }}"

    - name: "Hotfolder preparation"
      block:
        - name: "Create hotfolder root directory"
          file:
            path: "{{ hotfolder_root_path }}"
            state: "directory"
            owner: "root"
            group: "root"
            mode: "0755"
        - name: "Create hotfolder directory"
          file:
            path: "{{ hotfolder_root_path }}/amway"
            state: "directory"
            owner: "{{ htools_username }}"
            group: "{{ htools_groupname }}"
            mode: "0755"
      become: True
    
    - name: "Add startup delay in hybrisd.service"
      become: True
      lineinfile:
        path: /etc/systemd/system/hybrisd.service
        state: present
        line: "ExecStartPre=/bin/sleep {{ hybrisd_service_startup_delay }}"
        insertbefore: "ExecStart=/bin/bash -c './hybrisserver.sh start'"

    - name: "Install DigiCert SHA2 Secure Server CA"
      block:
        - name: "Save DigiCert SHA2 Secure Server CA"
          copy:
            dest: /tmp/DigiCertSHA2SecureServerCA.cer
            content: |
              -----BEGIN CERTIFICATE-----
              MIIElDCCA3ygAwIBAgIQAf2j627KdciIQ4tyS8+8kTANBgkqhkiG9w0BAQsFADBh
              MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
              d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBD
              QTAeFw0xMzAzMDgxMjAwMDBaFw0yMzAzMDgxMjAwMDBaME0xCzAJBgNVBAYTAlVT
              MRUwEwYDVQQKEwxEaWdpQ2VydCBJbmMxJzAlBgNVBAMTHkRpZ2lDZXJ0IFNIQTIg
              U2VjdXJlIFNlcnZlciBDQTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
              ANyuWJBNwcQwFZA1W248ghX1LFy949v/cUP6ZCWA1O4Yok3wZtAKc24RmDYXZK83
              nf36QYSvx6+M/hpzTc8zl5CilodTgyu5pnVILR1WN3vaMTIa16yrBvSqXUu3R0bd
              KpPDkC55gIDvEwRqFDu1m5K+wgdlTvza/P96rtxcflUxDOg5B6TXvi/TC2rSsd9f
              /ld0Uzs1gN2ujkSYs58O09rg1/RrKatEp0tYhG2SS4HD2nOLEpdIkARFdRrdNzGX
              kujNVA075ME/OV4uuPNcfhCOhkEAjUVmR7ChZc6gqikJTvOX6+guqw9ypzAO+sf0
              /RR3w6RbKFfCs/mC/bdFWJsCAwEAAaOCAVowggFWMBIGA1UdEwEB/wQIMAYBAf8C
              AQAwDgYDVR0PAQH/BAQDAgGGMDQGCCsGAQUFBwEBBCgwJjAkBggrBgEFBQcwAYYY
              aHR0cDovL29jc3AuZGlnaWNlcnQuY29tMHsGA1UdHwR0MHIwN6A1oDOGMWh0dHA6
              Ly9jcmwzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEdsb2JhbFJvb3RDQS5jcmwwN6A1
              oDOGMWh0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEdsb2JhbFJvb3RD
              QS5jcmwwPQYDVR0gBDYwNDAyBgRVHSAAMCowKAYIKwYBBQUHAgEWHGh0dHBzOi8v
              d3d3LmRpZ2ljZXJ0LmNvbS9DUFMwHQYDVR0OBBYEFA+AYRyCMWHVLyjnjUY4tCzh
              xtniMB8GA1UdIwQYMBaAFAPeUDVW0Uy7ZvCj4hsbw5eyPdFVMA0GCSqGSIb3DQEB
              CwUAA4IBAQAjPt9L0jFCpbZ+QlwaRMxp0Wi0XUvgBCFsS+JtzLHgl4+mUwnNqipl
              5TlPHoOlblyYoiQm5vuh7ZPHLgLGTUq/sELfeNqzqPlt/yGFUzZgTHbO7Djc1lGA
              8MXW5dRNJ2Srm8c+cftIl7gzbckTB+6WohsYFfZcTEDts8Ls/3HB40f/1LkAtDdC
              2iDJ6m6K7hQGrn2iWZiIqBtvLfTyyRRfJs8sjX7tN8Cp1Tm5gr8ZDOo0rwAhaPit
              c+LJMto4JQtV05od8GiG7S5BNO98pVAdvzr508EIDObtHopYJeS4d60tbvVS3bR0
              j6tJLp07kzQoH3jOlOrHvdPJbRzeXDLz
              -----END CERTIFICATE-----

        - name: "Get JAVA_HOME location"
          command: "echo $JAVA_HOME"
          register: java_location

        - name: "Import certificate into java keystore"
          java_cert:
            cert_path: /tmp/DigiCertSHA2SecureServerCA.cer
            cert_alias: DigiCertSHA2SecureServerCA
            keystore_path: "{{ java_location.stdout }}/lib/security/cacerts"
            keystore_pass: changeit
            executable: "{{ java_location.stdout }}/bin/keytool"
            state: present
          become: True