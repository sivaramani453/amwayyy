#!/usr/bin/php
<?php

$smile = "(whew)";
if (strpos($argv[2], "PROBLEM:") !== false) {
    $smile = "(shock)";
}

$url = "{{ misc_skype_bot_url }}";
$data = [
    'channel' => $argv[1],
    'secret' => '{{ misc_skype_secret }}',
    'type' => 'simple',
    'text' => $smile . " Zabbix notification.<br/>" . str_replace('&', '&amp;', $argv[2]) . "<br/>" . str_replace('&', '&amp;', $argv[3])
];

$data_string = json_encode($data); 

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
curl_setopt($ch, CURLOPT_POSTFIELDS, $data_string);
curl_setopt($ch, CURLOPT_HTTPHEADER, array(
    'Content-Type: application/json',
    'Content-Length: ' . strlen($data_string),
    'accept-version: 1.0.0')
);
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

$result = curl_exec($ch);
curl_close($ch);

if (!$result) {
    error_log(date('Y-m-d H:i:s') . " Notification not sent" . "\n", 3, "chatbot.error_log");
}

return $result;
