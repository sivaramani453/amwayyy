---
- hosts: 'all'
  
  roles:
  - role: '../roles/lean_delivery.docker'

  post_tasks:
   - name: Enable and Install additional repositories and packages
     block:
       - name: Enable repositories
         yum:
           name: '{{ item }}'
           state: present
         loop: '{{ repo_urls }}'  
  
       - name: Install system packages
         yum:
           name: '{{ item }}'
           state: present
         loop: '{{ system_packages }}'

       - name: Install pip packages
         pip:
           name: '{{ item }}'
         loop: '{{ pip_packages }}'

     become: True

   - name: 'Login into docker registry {{ docker_registry_name }}'
     docker_login:
       registry: '{{ docker_registry_name }}'
       username: '{{ docker_registry_username }}'
       password: '{{ docker_registry_password }}'
     become: True   

   - name: Install docker-compose
     get_url:
       url: '{{ docker_compose_url }}'
       dest: '{{ docker_compose_path }}'
       owner: 'root'
       group: 'root'
       mode: '0755'
       seuser: 'system_u'
       serole: 'object_r'
       setype: 'bin_t'
       selevel: 's0'
     register: docker_compose_downloaded
     until: docker_compose_downloaded is succeeded
     retries: 3
     delay: 2  
     become: True
