---
- hosts: 'all'

  tasks:
    - name: Update and install tools
      include_tasks: prepare.yaml

    - name: Configure nginx
      block:
        - name: Generate php-fpm config
          template:
            src: www.conf.j2
            dest: "/etc/php-fpm.d/www.conf"
            owner: root
            group: root
            mode: "0644"

        - name: Enable php-fpm service
          systemd:
            name: php-fpm
            enabled: yes

        - name: Generate nginx.conf
          template:
            src: nginx.conf.j2
            dest: "/etc/nginx/nginx.conf"
            owner: root
            group: root
            mode: "0644"

        - name: Enable nginx service
          systemd:
            name: nginx
            enabled: yes

      become: True
      tags: nginx-config

    - name: Updatedb
      block:
        - name: Exclude the ultraserve dumps folder
          lineinfile:
            path: "/etc/updatedb.conf"
            regexp: "^(.*)PRUNEPATHS(.*)$"
            line: "PRUNEPATHS = \"/afs /media /mnt /net /sfs /tmp /udev /var/cache/ccache /var/lib/yum/yumdb /var/spool/cups /var/spool/squid /var/tmp /var/lib/ceph {{ dumps_mount_dir }}\""
            backrefs: yes  

      become: True
      tags: updatedb
