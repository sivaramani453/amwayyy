---
- hosts: "all"
  remote_user: root
  # Just to make things easy
  pre_tasks:
    - name: "Disable Selinux"
      become: True
      selinux:
        state: "disabled"

    - name: Update ca-certificates package
      become: True
      yum:
        name: "ca-certificates"
        state: "latest"

    - name: "Add root developer key"
      become: True
      lineinfile:
        path: /root/.ssh/authorized_keys
        line: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2tPISkT8O76W0ZoDzZ2vxrAfH7BulmBIfNwDYM5gyLWZx9y+7i7xGbF/i56OFcmgG5zuVuYGbs62+147Kvj+9CEhK0Z13J8IOuZgFwz5ENSjp43ov9wXaxQ3RlkHnKhhF4xQU+OGvF+aoxPIBM7os/lWP0szNbPT/4WteZTIONBgg4LA02V0m401g72Rg04IlJc8H8YrgvZPnZDuf7KDklY47Z/9Uq2h+qp0tb6L8psoBOClkU4/se1FWgnXocj3FcxnfAmlI1p5d4D8zXIHJn1K3CQFsDmLN5NmtcOy44foQ55IM4K6/m/yCB4IBh7tFeIaWkcUb+qmSf1U0tv7V'
        create: True

  vars:
    # Global variables
    hotfolder_root_path: "/opt/hotfolder"
    htools_username: "hybris"
    htools_groupname: "hybris"
    hybris_user_password: "$1$SomeSalt$ZPlQbPwkyCQJ01vGNIRNE0"
    solr_version: "7.1.0"

  roles:
  - role: "../roles/lean_delivery.java"
    transport: "web"
    transport_web: "https://nexus.hybris.eu.eia.amway.net/repository/static-files/static-dev/jre-8u171-linux-x64.tar.gz"

  - role: '../roles/lean_delivery.hybris_bootstrap_node'
    htools_upload_dir: "/opt"
    htools_purge_hybris_home: True
    htools_legacy_structure: True
    hybris_artifact_path: "aweu-eia"
    htools_artifact_storage: "https://nexus.hybris.eu.eia.amway.net/service/rest/repository/browse/{{ hybris_artifact_path }}"
    hybris_env_ant_opts: "-Xmx1g -Dfile.encoding=UTF-8"

  - role: '../roles/dev-debug-gui'
    vnc_user: "{{ htools_username }}"
    vnc_group: "{{ htools_groupname }}"
    vnc_password: "hybris"
  - role: '../roles/jrebel'
    jrebel_artifact_url: "https://nexus.hybris.eu.eia.amway.net/repository/static-files/static-dev/jrebel"
    jrebel_artifact_name: "jrebel-latest-nosetup.zip"

  - role: '../roles/lean_delivery.solr_standalone'
    solr_java_xms: "2G"
    solr_java_xmx: "2G"
    solr_ssl_configure: False
    solr_auth_configure: False

  - role: '../roles/lean_delivery.solr_hybris_config'
    solr_patch_transport: "web"
    solr_patch_transport_web: "https://nexus.hybris.eu.eia.amway.net/repository/static-files/static-dev"
    solr_contrib_hybris_patch_name: "solrCustomizations-7.1.0-contrib.zip"
    solr_data_hybris_patch_name: "solrCustomizations-7.1.0-data.zip"

  - role: '../roles/lean_delivery.mysql'
    mysql_root_password: "LKJnk3542390jMJhoipjmrg"
    mysql_root_username: "root"
    mysql_user_home: "/home/centos"
    mysql_user_name: "centos"
    mysql_user_password: "centos"
    mysql_databases:
      - name: "hybris"
    mysql_users:
      - name: "hybris"
        host: ""
        password: "LKJNo3j5390tKJo[ksf435]"
        priv: "hybris.*:ALL,GRANT"
    mysql_daemon: "mysqld"
    mysql_version: "5.6"
    mysql_max_allowed_packet: "16384K"
    mysql_query_cache_type: "1"
    mysql_innodb_flush_log_at_trx_commit: "0"
    mysql_innodb_buffer_pool_size: "6G"
    mysql_max_connections: "400"
    mysql_key_buffer_size: "81920K"
    mysql_read_buffer_size: "1280K"
    mysql_table_open_cache: "400"
    mysql_slow_query_time: "10"
    mysql_log_error: "/var/log/mysqld.log"
    additional_parameters:
      - name: lc-messages-dir
        value: "/usr/share/mysql"
      - name: thread_stack
        value: "192K"
      - name: character_set_server
        value: "utf8"
      - name: sync_binlog
        value: "0"
      - name: transaction_isolation
        value: "REPEATABLE-READ"
      - name: innodb_buffer_pool_instances
        value: "8"
      - name: innodb_purge_threads
        value: "4"
      - name: innodb_flush_method
        value: "O_DIRECT"
      - name: general_log
        value: "0"

  - role: '../roles/lean_delivery.nodejs'
    nodejs_branch: 12
    nodejs_version: 12.13.0
    build_tools: True

  - role: '../roles/external-ansible-sshd'
    become: True
    sshd:
      Match:
        - Condition: "user {{ htools_username }}"
          ForceCommand: "internal-sftp"
          PasswordAuthentication: yes
          X11Forwarding: no
          AllowTcpForwarding: no
          PermitTunnel: no
          ChrootDirectory: "{{ hotfolder_root_path }}"

  - role: '../roles/openmicroscopy.ssl-certificate'

  - role: '../roles/ansible-role-nginx'
    become: True
    nginx_http_template_enable: true
    nginx_http_template:
      default:
        template_file: http/default.conf.j2
        conf_file_name: default.conf
        conf_file_location: /etc/nginx/conf.d/
        port: 443
        server_name: localhost
        error_page: /usr/share/nginx/html
        autoindex: false
        ssl:
          cert: /etc/ssl/localcerts/bundled.crt
          key: /etc/ssl/localcerts/server.key
          protocols: TLSv1 TLSv1.1 TLSv1.2
          ciphers: HIGH:!aNULL:!MD5
          session_cache: none
          session_timeout: 5m
        reverse_proxy:
          locations:
            backend:
              location: /
              proxy_pass: https://backend_servers
              proxy_read_timeout: 200
              proxy_connect_timeout: 100
              proxy_set_header:
                header_host:
                  name: Host
                  value: $host
                header_x_real_ip:
                  name: X-Real-IP
                  value: $remote_addr
                header_x_forwarded_for:
                  name: X-Forwarded-For
                  value: $proxy_add_x_forwarded_for
                header_x_forwarded_proto:
                  name: X-Forwarded-Proto
                  value: $scheme
        upstreams:
          upstream_1:
            name: backend_servers
            lb_method: least_conn
            zone_name: backend
            zone_size: 64k
            sticky_cookie: false
            servers:
              backend_server_1:
                address: 127.0.0.1
                port: 9002
                weight: 1
                health_check: max_fails=3 fail_timeout=5s
  - role: '../roles/gantsign.intellij'
    intellij_version: '2019.3.3'

  post_tasks:
    - name: "Setup hybris user password"
      become: True
      user:
        name: "{{ htools_username }}"
        password: "{{ hybris_user_password }}"

    - name: "Create media directory"
      become: True
      file:
        path: "/opt/media"
        state: "directory"
        owner: "{{ htools_username }}"
        group: "{{ htools_groupname }}"
        mode: "0755"

    - name: "Install packages"
      become: True
      package:
        name: "{{ item }}"
        state: present
      loop:
        - git-1.8.3.1
        - bzip2-1.0.6
        - samba
        - vim
        - gedit
        - screen

    - name: "Download hybris platform"
      get_url:
        url: "{{ download_hybris_url }}"
        dest: "/tmp/hybris.zip"
      register: result
      until: result is succeeded
      retries: 10
      delay: 2
      become: True

    # Unarchive module takes too much time
    - name: Unarchive hybris platform
      become: True
      command: "unzip -o -q /tmp/hybris.zip -d /opt"

    #Jira task AMWRUS-15989
    - name: Check Samba installation
      command: "chkconfig smb on"
      become: True

    - name: Start and enable samba service
      service:
        name: smb
        state: started
        enabled: yes
      become: True

    - name: Configuring Samba server
      template:
        src: smb_conf.j2
        dest: /etc/samba/smb.conf
        owner: root
        group: root
        mode: 0644
      become: True
      notify: restart Samba

    - name: Generate Hybris user password for samba
      raw: yes hybris | smbpasswd -a hybris
      become: True

    - name: Enable Hybris user in samba
      command: smbpasswd -e hybris
      become: True

  handlers:
    - name: restart Samba
      service: name=smb state=restarted
      become: True
